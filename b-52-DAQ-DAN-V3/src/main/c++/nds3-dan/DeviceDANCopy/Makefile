#+======================================================================
# $HeadURL: https://svnpub.iter.org/codac/iter/codac/dev/units/m-codac-unit-templates/tags/CODAC-CORE-6.0.0/templates/cpp/main/c++/lib/Makefile.template $
# $Id: Makefile.template 83538 2018-01-26 15:14:56Z cesnikt $
#
# Project       : CODAC Core System
#
# Description   : $progName Makefile
#
# Author        : This file was generated by CODAC development toolkit
#
# Copyright (c) : 2010-2018 ITER Organization,
#                 CS 90 046
#                 13067 St. Paul-lez-Durance Cedex
#                 France
#
# This file is part of ITER CODAC software.
# For the terms and conditions of redistribution or use of this software
# refer to the file ITER-LICENSE.TXT located in the top level directory
# of the distribution package.
#
#-======================================================================

LIBNAME=nds-dan-device-Copy

LIBRARIES=ca dan_api dan_client_api dan_stream dan_base xml2 log tcn nds3
LIBRARY_DIRS=
INCLUDE_DIRS=. ../  ../../include $(CODAC_ROOT)/include $(EPICS_BASE)/include/os/Linux $(EPICS_BASE)/include/compiler/gcc $(EPICS_BASE)/include /usr/include/libxml2

DEFS = -DEPICS
DEVEL=false
ifeq ($(DEVEL),true)
	INCLUDE_DIRS += ../../../include
else
	LIBRARIES += nds-dan
endif


TARGET=./../target
LIBRARY_DIR=$(TARGET)/lib
LIBRARY_DIRS+=$(TARGET)/lib
LIBRARY_DIRS+=/home/codac-dev/m-nds-dan/trunk/target/lib
SOURCE_DIR=.
OBJECT_DIR=$(SOURCE_DIR)/.obj

SHAREDLIBRARY=$(LIBRARY_DIR)/lib$(LIBNAME).so
STATICLIBRARY=$(LIBRARY_DIR)/lib$(LIBNAME).a
INCLUDES=$(foreach inc,$(INCLUDE_DIRS),-I$(inc))
LDLIBS=-L$(CODAC_ROOT)/lib -L$(EPICS_BASE)/lib/$(EPICS_HOST_ARCH) $(foreach libs,$(LIBRARY_DIRS),-L$(libs) -Wl,-rpath,$(libs)) $(foreach libs,$(LIBRARIES),-l$(libs))
SOURCES=$(SOURCE_DIR)/$(wildcard *.cpp)
OBJECTS=$(addprefix $(OBJECT_DIR)/,$(patsubst %.cpp,%.o,$(notdir $(SOURCES))))
HFILES=$(wildcard *.h)
HTARGETS=$(addprefix $(TARGET)/include/, $(HFILES))

C=gcc
CC=g++
CFLAGS=-c -Wall -fPIC
CCFLAGS=-c -Wall -fPIC -std=c++11
LDFLAGS= -shared 


ifeq ($(COVERAGE),true)
	CFLAGS+= -O0 -g --coverage
 	CCFLAGS+= -O0 -g --coverage
 	LDFLAGS+= --coverage
endif


.PHONY: all clean run 

all: $(HTARGETS) $(SOURCES) $(SHAREDLIBRARY) $(STATICLIBRARY)

$(TARGET)/include/%.h: %.h
	@mkdir -p $(TARGET)/include
	cp $< $@

clean:
	rm -rf "$(SHAREDLIBRARY)" "$(STATICLIBRARY)" "$(OBJECT_DIR)" "$(HTARGETS)"

run: $(SOURCES) $(SHAREDLIBRARY)
	$(SHAREDLIBRARY)

$(SHAREDLIBRARY): $(OBJECTS)
	mkdir -p $(LIBRARY_DIR)
	$(CC) $(LDFLAGS) $(DEFS) $(LDLIBS) $(OBJECTS) -o $(SHAREDLIBRARY) 

$(STATICLIBRARY): $(OBJECTS)
	mkdir -p $(LIBRARY_DIR)
	$(AR) rcs $@ $^
	
$(OBJECT_DIR)/%.o: $(SOURCE_DIR)/%.cpp
	mkdir -p $(OBJECT_DIR)
	$(CC) $(CCFLAGS) $(DEFS) $(INCLUDES) $< -o $@

$(OBJECT_DIR)/%.o: $(SOURCE_DIR)/%.c
	mkdir -p $(OBJECT_DIR)
	$(C) $(CFLAGS) $(INCLUDES) $< -o $@
